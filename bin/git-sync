#!/bin/bash
set -eu -o pipefail

heading() {
	tput setaf 6
	echo "$@"
	tput sgr0
}

git fetch -p --progress

tab="%09"
git for-each-ref --format="%(refname:short)x$tab%(upstream:short)x$tab%(worktreepath)x" refs/heads \
	| while read -r line; do
		set -- $line
		localBranch="${1%x}"
		remoteBranch="${2%x}"
		worktree="${3%x}"
		if [ -z "$remoteBranch" ]; then
			continue
		fi
		if [ -n "${worktree:-}" ] && [ "${worktree:-}" != "$(git rev-parse --show-toplevel)" ]; then
			continue
		fi
		if ! [[ "$remoteBranch" =~ origin/* ]]; then
			continue
		fi
		if [ "$(git rev-parse "$localBranch" --)" = "$(git rev-parse "$remoteBranch" --)" ]; then
			continue
		fi
		if git ls-remote --exit-code origin "${remoteBranch#origin/}" &> /dev/null; then
			heading "Sync $remoteBranch --> $localBranch"
			if [ "$localBranch" = "$(git rev-parse --abbrev-ref HEAD)" ]; then
				git merge "$remoteBranch" --ff-only --no-verify
			else
				git push . "$remoteBranch":"$localBranch" --no-verify || true
			fi
		else
			heading "Deleting $localBranch"
			git branch -d "$localBranch" || true
		fi
	done
